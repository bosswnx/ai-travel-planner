# AI Travel Planner

面向中文用户的 AI 智能旅行规划平台，结合语音输入、行程生成、费用管理与地图导航能力，帮助用户快速制定并管理多端同步的旅行计划。

## 功能亮点

- 🤖 **智能行程规划**：支持语音或文字输入旅行需求，调用大语言模型生成包含交通、住宿、景点、美食的 Markdown 行程。
- 🗺️ **目的地地图预览**：集成高德地图 API，输入目的地即可实时定位核心景点。
- 💰 **预算与费用管理**：记录旅行开销，自动调用 AI 输出节省建议和预算分析。
- ☁️ **云端同步接口**：通过 Supabase API (可选) 存储行程与费用，支持多设备查看。
- 🔐 **敏感信息安全**：所有 API Key 通过环境变量注入，未写入代码库。

## 项目结构

```
ai-travel-planner/
├── backend/              # Node.js + Express API 服务
│   ├── src/
│   ├── Dockerfile
│   └── .env.example
├── frontend/             # Vite + React Web 客户端
│   ├── src/
│   ├── Dockerfile
│   └── .env.example
├── docker-compose.yml    # 一键启动前后端与反向代理
├── docs/
│   └── submission.pdf    # 作业提交文件
└── README.md
```

## 快速开始

### 1. 准备环境变量

复制示例文件并填入自己的 Key。

```bash
cp backend/.env.example backend/.env
cp frontend/.env.example frontend/.env
```

**必须字段**

后端 `backend/.env`：

- `LLM_API_KEY`：通用大语言模型密钥。
- `AMAP_WEB_KEY`：高德开放平台 JS API Key，Docker 模式下会自动透传给前端。
- `SUPABASE_URL` & `SUPABASE_ANON_KEY`：可选，若配置则行程与费用会保存至 Supabase 数据库。未配置时使用内存存储（便于演示）。

前端 `frontend/.env`：

- `VITE_AMAP_KEY`：高德开放平台 Web JS API Key（建议与 `AMAP_WEB_KEY` 保持一致）。
- `VITE_API_BASE`：可选，指定前端调用后端的基础 URL；若留空，系统会自动回退到当前站点域名。

> 所有前端运行时配置会在 `frontend/src/config.js` 中集中读取，方便未来扩展或接入更多地图/模型服务。

**自定义大模型服务（可选）**

- `LLM_API_BASE_URL`：若使用自建 / 第三方兼容 OpenAI SDK 的服务，填写自定义请求地址。
- `LLM_MODEL`：后端调用的默认模型名称，未配置时默认为 `gpt-4o-mini`。

> ⚠️ 若使用其它语音识别 / LLM 服务，可在 `backend/src/services/llmService.js` 和 `frontend/src/hooks/useSpeechRecognition.js` 内按需替换 SDK。

### 2. 安装依赖与本地运行

在项目根目录执行：

```bash
# 安装后端依赖
cd backend
npm install
npm run start # 或 npm run dev

# 另开终端启动前端
cd ../frontend
npm install
npm run dev
```

访问 `http://localhost:5173` 即可体验。

### 3. Docker 一键运行

```bash
# 构建并启动
VITE_AMAP_KEY=你的高德Key docker compose up --build
```

- 前端：`http://localhost:5173`
- 后端：`http://localhost:4000/api`

> 若需推送到阿里云镜像仓库，可在 GitHub Actions 中使用 `docker/build-push-action`，将 `backend/` 与 `frontend/` 目录分别构建并推送。Actions 样例可参考 README 末尾链接。

## API 说明

| 方法 | 路径 | 描述 |
| ---- | ---- | ---- |
| `POST` | `/api/plan` | 根据输入生成行程并保存 |
| `GET` | `/api/plan` | 查询历史行程（需 userId） |
| `POST` | `/api/budget` | 调用 LLM 输出预算分析 |
| `POST` | `/api/expenses` | 记录一条费用支出 |
| `GET` | `/api/expenses` | 查询费用记录 |

请求体示例：

```json
{
  "userId": "demo-user",
  "destination": "日本东京",
  "startDate": "2024-07-01",
  "days": 5,
  "budget": 10000,
  "travelers": 3,
  "preferences": "美食, 动漫",
  "notes": "带 6 岁孩子，想安排主题乐园"
}
```

## Supabase 表结构建议

若启用云端存储，请在 Supabase 中创建以下表：

```sql
create table travel_plans (
  id bigint generated by default as identity primary key,
  user_id text not null,
  plan jsonb not null,
  created_at timestamp with time zone default now()
);

create table expenses (
  id bigint generated by default as identity primary key,
  user_id text not null,
  expense jsonb not null,
  created_at timestamp with time zone default now()
);
```

## PDF 提交文件

`docs/submission.pdf` 包含 GitHub 仓库地址与 README 下载说明，可直接随作业提交。

## 常见问题

1. **语音识别无法使用？**
   - Web Speech API 仅在 Chrome/Edge 等浏览器支持，Safari 需在设置中开启。
   - 如需移动端适配，可调用科大讯飞等在线语音识别 API，将识别结果填入备注文本框。

2. **LLM 费用超支？**
   - 可在 `backend/src/services/llmService.js` 内调整模型、温度与输出格式，或增加缓存逻辑。

3. **高德地图无显示？**
   - 确认 `VITE_AMAP_KEY` 已在高德控制台启用 JS API，并允许本地调试域名。
   - 若页面提示缺少 Key，请在 `.env` 或部署平台中补充，并重新构建前端静态资源。

4. **前端提示“网络请求失败，请检查后端服务是否可用或 API 地址是否正确配置。”？**
   - 请确认 `frontend/src/config.js` 中解析到的 `apiBase` 地址可从浏览器访问（例如本地调试需同时运行后端服务）。
   - 在生产部署中，建议显式设置 `VITE_API_BASE=https://你的后端域名`，以避免跨域或协议混用导致的请求失败。

## Docker 镜像发布参考

可在 `.github/workflows` 内新增如下 Action，将镜像推送至阿里云 ACR：

```yaml
- uses: docker/setup-buildx-action@v3
- uses: docker/login-action@v3
  with:
    registry: registry.cn-hangzhou.aliyuncs.com
    username: \${{ secrets.ACR_USERNAME }}
    password: \${{ secrets.ACR_PASSWORD }}
- uses: docker/build-push-action@v5
  with:
    context: ./backend
    push: true
    tags: registry.cn-hangzhou.aliyuncs.com/your-namespace/ai-travel-planner-backend:latest
```

## License

MIT
